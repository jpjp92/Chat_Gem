name: Realistic User Activity Simulator

on:
  schedule:
    # ë‹¤ì–‘í•œ ì‹œê°„ëŒ€ì— ì‹¤í–‰ (ì‹¤ì œ ì‚¬ìš©ì íŒ¨í„´ ëª¨ë°©)
    - cron: "15 */6 * * *"   # ë§¤ 6ì‹œê°„ë§ˆë‹¤ 15ë¶„ì—
  workflow_dispatch:

env:
  STREAMLIT_URL: ${{ secrets.STREAMLIT_URL }}
  STREAMLIT_URLS: ${{ secrets.STREAMLIT_URLS }}
  SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}

jobs:
  realistic-simulation:
    runs-on: ubuntu-latest
    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Realistic User Activity Simulation
        run: |
          # URL ì„¤ì •
          URLS="$STREAMLIT_URLS"
          if [ -z "$URLS" ]; then
            URLS="$STREAMLIT_URL"
          fi
          if [ -z "$URLS" ]; then
            URLS="https://assistant-gemini25.streamlit.app,https://mbti-multi.streamlit.app,https://ko-chat-bot25.streamlit.app"
            echo "ğŸ”— Using default URL list"
          fi

          if [ -z "$URLS" ]; then
            echo "âŒ No URLs configured"
            exit 1
          fi

          IFS=',' read -ra ADDR <<< "$URLS"
          SUCCESS_COUNT=0
          TOTAL_COUNT=0

          # ëœë¤ User-Agent ë°°ì—´
          USER_AGENTS=(
            "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
            "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
            "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/121.0"
            "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.2 Safari/605.1.15"
            "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
          )

          simulate_realistic_user() {
            raw="$1"
            URL=$(echo "$raw" | sed -e 's/^\s*//' -e 's/\s*$//')
            URL="${URL%/}"
            TOTAL_COUNT=$((TOTAL_COUNT + 1))
            
            # ëœë¤ User-Agent ì„ íƒ
            UA_INDEX=$((RANDOM % ${#USER_AGENTS[@]}))
            USER_AGENT="${USER_AGENTS[$UA_INDEX]}"
            
            echo "\nğŸ­ === Simulating realistic user for: $URL ==="
            echo "ğŸ‘¤ User-Agent: $(echo "$USER_AGENT" | cut -d' ' -f1-3)..."

            # ì¿ í‚¤ íŒŒì¼ ìƒì„±
            COOKIE_FILE="/tmp/cookies_${TOTAL_COUNT}_$(date +%s).txt"
            
            # Phase 1: ì‹¤ì œ ë¸Œë¼ìš°ì €ì²˜ëŸ¼ ì²« ë°©ë¬¸
            echo "ğŸ“± Phase 1: Initial page visit (like opening browser tab)"
            response1=$(curl -s -L -c "$COOKIE_FILE" --max-time 45 \
              -w "HTTPSTATUS:%{http_code};TIME:%{time_total};SIZE:%{size_download}" \
              -H "User-Agent: $USER_AGENT" \
              -H "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8" \
              -H "Accept-Language: en-US,en;q=0.9,ko;q=0.8" \
              -H "Accept-Encoding: gzip, deflate, br" \
              -H "DNT: 1" \
              -H "Connection: keep-alive" \
              -H "Upgrade-Insecure-Requests: 1" \
              -H "Sec-Fetch-Dest: document" \
              -H "Sec-Fetch-Mode: navigate" \
              -H "Sec-Fetch-Site: none" \
              -H "Cache-Control: max-age=0" \
              "$URL" 2>/dev/null || echo "HTTPSTATUS:000;TIME:0;SIZE:0")

            http_code1=$(echo "$response1" | sed -n 's/.*HTTPSTATUS:\([0-9]*\).*/\1/p')
            time1=$(echo "$response1" | sed -n 's/.*TIME:\([0-9.]*\).*/\1/p')
            size1=$(echo "$response1" | sed -n 's/.*SIZE:\([0-9]*\).*/\1/p')
            
            echo "   ğŸ“Š HTTP: $http_code1, Time: ${time1}s, Size: ${size1} bytes"

            # ì‚¬ìš©ìê°€ í˜ì´ì§€ë¥¼ ì½ëŠ” ì‹œê°„ ì‹œë®¬ë ˆì´ì…˜ (5-15ì´ˆ)
            read_time=$((5 + RANDOM % 11))
            echo "   ğŸ‘€ User reading page... (${read_time}s)"
            sleep $read_time

            # Phase 2: ì •ì  ë¦¬ì†ŒìŠ¤ ìš”ì²­ (ì‹¤ì œ ë¸Œë¼ìš°ì € ë™ì‘)
            echo "ğŸ“¦ Phase 2: Loading page resources (CSS, JS, favicon)"
            
            # CSS ìš”ì²­
            curl -s -b "$COOKIE_FILE" --max-time 20 \
              -H "User-Agent: $USER_AGENT" \
              -H "Accept: text/css,*/*;q=0.1" \
              -H "Referer: $URL" \
              "$URL/_stcore/static/css/bootstrap.min.css" > /dev/null 2>&1 || true
            
            sleep 1
            
            # Favicon ìš”ì²­  
            curl -s -b "$COOKIE_FILE" --max-time 15 \
              -H "User-Agent: $USER_AGENT" \
              -H "Accept: image/webp,image/apng,image/svg+xml,image/*,*/*;q=0.8" \
              -H "Referer: $URL" \
              "$URL/favicon.ico" > /dev/null 2>&1 || true

            sleep 2

            # Phase 3: WebSocket ì—°ê²° ì‹œë®¬ë ˆì´ì…˜ (Streamlit íŠ¹í™”)
            echo "ğŸ”Œ Phase 3: Simulating Streamlit WebSocket connection"
            curl -s -b "$COOKIE_FILE" --max-time 15 \
              -H "User-Agent: $USER_AGENT" \
              -H "Connection: Upgrade" \
              -H "Upgrade: websocket" \
              -H "Sec-WebSocket-Key: $(echo -n "streamlit-$(date +%s)" | base64)" \
              -H "Sec-WebSocket-Version: 13" \
              -H "Origin: $URL" \
              "$URL/_stcore/stream" > /dev/null 2>&1 || true

            sleep 3

            # Phase 4: ì‚¬ìš©ì ìƒí˜¸ì‘ìš© ì‹œë®¬ë ˆì´ì…˜
            echo "ğŸ–±ï¸ Phase 4: Simulating user interactions"
            
            # ë‹¤ì‹œ ë©”ì¸ í˜ì´ì§€ ìš”ì²­ (ì‚¬ìš©ìê°€ ë­”ê°€ í´ë¦­)
            response2=$(curl -s -L -b "$COOKIE_FILE" --max-time 30 \
              -w "HTTPSTATUS:%{http_code};TIME:%{time_total}" \
              -H "User-Agent: $USER_AGENT" \
              -H "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8" \
              -H "Referer: $URL" \
              -H "Sec-Fetch-Dest: document" \
              -H "Sec-Fetch-Mode: navigate" \
              -H "Sec-Fetch-Site: same-origin" \
              "$URL" 2>/dev/null || echo "HTTPSTATUS:000;TIME:0")

            http_code2=$(echo "$response2" | sed -n 's/.*HTTPSTATUS:\([0-9]*\).*/\1/p')
            time2=$(echo "$response2" | sed -n 's/.*TIME:\([0-9.]*\).*/\1/p')
            
            echo "   ğŸ”„ Interaction response: HTTP $http_code2, Time: ${time2}s"

            # ë” ë§ì€ ìƒí˜¸ì‘ìš© ì‹œë®¬ë ˆì´ì…˜
            interaction_count=$((1 + RANDOM % 3))  # 1-3ë²ˆì˜ ì¶”ê°€ ìƒí˜¸ì‘ìš©
            for i in $(seq 1 $interaction_count); do
              sleep $((2 + RANDOM % 5))  # 2-6ì´ˆ ëŒ€ê¸°
              
              # ëœë¤ ì—”ë“œí¬ì¸íŠ¸ ìš”ì²­
              endpoints=("" "/_stcore/health" "/_stcore/ping")
              endpoint_idx=$((RANDOM % ${#endpoints[@]}))
              endpoint="${endpoints[$endpoint_idx]}"
              
              curl -s -b "$COOKIE_FILE" --max-time 15 \
                -H "User-Agent: $USER_AGENT" \
                -H "Accept: application/json,*/*;q=0.8" \
                -H "Referer: $URL" \
                "$URL$endpoint" > /dev/null 2>&1 || true
                
              echo "   ğŸ¯ Additional interaction $i/$interaction_count"
            done

            # Phase 5: ì„¸ì…˜ ìœ ì§€ ì‹ í˜¸
            echo "ğŸ’“ Phase 5: Session keep-alive signals"
            for pulse in 1 2 3; do
              sleep 5
              curl -s -b "$COOKIE_FILE" --max-time 10 \
                -H "User-Agent: $USER_AGENT" \
                -H "Accept: */*" \
                -H "Referer: $URL" \
                -H "X-Streamlit-User: active" \
                "$URL" > /dev/null 2>&1 || true
              echo "   ğŸ’— Pulse $pulse/3"
            done

            # ê²°ê³¼ í‰ê°€
            if [[ "$http_code1" =~ ^[23] ]] || [[ "$http_code2" =~ ^[23] ]] || [[ "$http_code1" == "303" ]]; then
              echo "âœ… Realistic user simulation completed successfully!"
              echo "   ğŸ“ˆ App should recognize this as genuine user activity"
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
            else
              echo "âš ï¸ App might be having issues, but keep-alive signals sent"
              echo "   ğŸ”§ HTTP codes: $http_code1, $http_code2"
              # ì¸í”„ë¼ê°€ ì‘ë‹µí•˜ëŠ” ê²½ìš°ì—ë„ ì„±ê³µìœ¼ë¡œ ì¹´ìš´íŠ¸
              if [[ "$http_code1" != "000" ]] || [[ "$http_code2" != "000" ]]; then
                SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
              fi
            fi

            # ì •ë¦¬
            rm -f "$COOKIE_FILE"
            
            # ë‹¤ìŒ URL ì²˜ë¦¬ ì „ íœ´ì‹ (ì‹¤ì œ ì‚¬ìš©ìê°€ íƒ­ ì´ë™í•˜ëŠ” ì‹œê°„)
            tab_switch_delay=$((3 + RANDOM % 8))
            echo "   ğŸ”„ Switching to next app... (${tab_switch_delay}s)"
            sleep $tab_switch_delay
          }

          # ëª¨ë“  URLì— ëŒ€í•´ ì‹¤í–‰
          echo "ğŸš€ Starting realistic user activity simulation"
          echo "â° Current time: $(date)"
          
          for raw in "${ADDR[@]}"; do
            simulate_realistic_user "$raw"
          done

          # ìµœì¢… ë¦¬í¬íŠ¸
          echo "\nğŸ“Š === SIMULATION COMPLETE ==="
          echo "âœ… Successfully simulated: $SUCCESS_COUNT / $TOTAL_COUNT apps"
          echo "ğŸ“ˆ Success Rate: $(( SUCCESS_COUNT * 100 / TOTAL_COUNT ))%"
          echo "â° Total simulation time: ~$(( TOTAL_COUNT * 60 )) seconds"

          if [ $SUCCESS_COUNT -eq $TOTAL_COUNT ]; then
            echo "ğŸ‰ All apps received realistic user activity!"
            echo "   ğŸ›¡ï¸ Apps should stay awake much longer now"
          elif [ $SUCCESS_COUNT -gt 0 ]; then
            echo "âš ï¸ Partial success - some apps may need attention"
            
            if [ -n "$SLACK_WEBHOOK" ]; then
              timestamp=$(date '+%Y-%m-%d %H:%M:%S UTC')
              text="ğŸ¤– *Streamlit User Simulator Report*\n\n*Time:* $timestamp\n*Success:* $SUCCESS_COUNT / $TOTAL_COUNT apps\n*Status:* Partial success - some apps may need attention"
              payload="{\"text\":\"$text\"}"
              curl -s -X POST -H 'Content-type: application/json' --data "$payload" "$SLACK_WEBHOOK" || true
            fi
          else
            echo "âŒ Simulation failed for all apps"
            
            if [ -n "$SLACK_WEBHOOK" ]; then
              timestamp=$(date '+%Y-%m-%d %H:%M:%S UTC')
              text="ğŸš¨ *Streamlit User Simulator Alert*\n\n*Time:* $timestamp\n*Status:* All apps failed to respond to user simulation\n*Action Required:* Manual investigation needed"
              payload="{\"text\":\"$text\"}"
              curl -s -X POST -H 'Content-type: application/json' --data "$payload" "$SLACK_WEBHOOK" || true
            fi
            exit 1
          fi

          echo "\nğŸ¯ Next simulation scheduled based on cron patterns"
          echo "ğŸ’¡ This realistic approach should significantly reduce sleep mode occurrences"