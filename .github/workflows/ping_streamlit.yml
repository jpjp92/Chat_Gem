name: Simplified User Activity Simulator

on:
  schedule:
    # ë‹¤ì–‘í•œ ì‹œê°„ëŒ€ì— ì‹¤í–‰ (ì‹¤ì œ ì‚¬ìš©ì íŒ¨í„´ ëª¨ë°©)
    - cron: "15 */6 * * *"   # ë§¤ 6ì‹œê°„ë§ˆë‹¤ 15ë¶„ì—
  workflow_dispatch:

env:
  STREAMLIT_URL: ${{ secrets.STREAMLIT_URL }}
  STREAMLIT_URLS: ${{ secrets.STREAMLIT_URLS }}

jobs:
  simplified-simulation:
    runs-on: ubuntu-latest
    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Simplified User Activity Simulation
        run: |
          # URL ì„¤ì •
          URLS="$STREAMLIT_URLS"
          if [ -z "$URLS" ]; then
            URLS="$STREAMLIT_URL"
          fi
          if [ -z "$URLS" ]; then
            URLS="https://assistant-gemini25.streamlit.app,https://mbti-multi.streamlit.app,https://ko-chat-bot25.streamlit.app"
            echo "ğŸ”— Using default URL list"
          fi

          if [ -z "$URLS" ]; then
            echo "âŒ No URLs configured"
            exit 1
          fi

          IFS=',' read -ra ADDR <<< "$URLS"
          SUCCESS_COUNT=0
          TOTAL_COUNT=0

          # ëœë¤ User-Agent ë°°ì—´
          USER_AGENTS=(
            "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
            "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
            "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/121.0"
            "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
          )

          simulate_simple_user() {
            raw="$1"
            URL=$(echo "$raw" | sed -e 's/^\s*//' -e 's/\s*$//')
            URL="${URL%/}"
            TOTAL_COUNT=$((TOTAL_COUNT + 1))
            
            # ëœë¤ User-Agent ì„ íƒ
            UA_INDEX=$((RANDOM % ${#USER_AGENTS[@]}))
            USER_AGENT="${USER_AGENTS[$UA_INDEX]}"
            
            echo "\nğŸ­ === Simple user simulation for: $URL ==="
            echo "ğŸ‘¤ User-Agent: $(echo "$USER_AGENT" | cut -d' ' -f1-3)..."

            # Phase 1: ë©”ì¸ í˜ì´ì§€ ë°©ë¬¸
            echo "ğŸ“± Phase 1: Main page visit"
            response1=$(curl -s -L --max-time 30 \
              -w "HTTPSTATUS:%{http_code};TIME:%{time_total};SIZE:%{size_download}" \
              -H "User-Agent: $USER_AGENT" \
              -H "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8" \
              -H "Accept-Language: en-US,en;q=0.9,ko;q=0.8" \
              -H "Connection: keep-alive" \
              -H "Cache-Control: max-age=0" \
              "$URL" 2>/dev/null || echo "HTTPSTATUS:000;TIME:0;SIZE:0")

            http_code1=$(echo "$response1" | sed -n 's/.*HTTPSTATUS:\([0-9]*\).*/\1/p')
            time1=$(echo "$response1" | sed -n 's/.*TIME:\([0-9.]*\).*/\1/p')
            size1=$(echo "$response1" | sed -n 's/.*SIZE:\([0-9]*\).*/\1/p')
            
            echo "   ğŸ“Š HTTP: $http_code1, Time: ${time1}s, Size: ${size1} bytes"

            # ì‚¬ìš©ì í˜ì´ì§€ ì½ê¸° ì‹œë®¬ë ˆì´ì…˜ (3-8ì´ˆ)
            read_time=$((3 + RANDOM % 6))
            echo "   ğŸ‘€ User reading... (${read_time}s)"
            sleep $read_time

            # Phase 2: ê°„ë‹¨í•œ ë¦¬ì†ŒìŠ¤ ìš”ì²­
            echo "ğŸ“¦ Phase 2: Basic resource loading"
            
            # Favicon ìš”ì²­ë§Œ (ê°€ì¥ ì¼ë°˜ì )
            curl -s --max-time 10 \
              -H "User-Agent: $USER_AGENT" \
              -H "Accept: image/*,*/*;q=0.8" \
              -H "Referer: $URL" \
              "$URL/favicon.ico" > /dev/null 2>&1 || true

            sleep 2

            # Phase 3: í•œ ë²ˆì˜ ì¶”ê°€ ìƒí˜¸ì‘ìš©
            echo "ğŸ–±ï¸ Phase 3: User interaction"
            response2=$(curl -s -L --max-time 20 \
              -w "HTTPSTATUS:%{http_code};TIME:%{time_total}" \
              -H "User-Agent: $USER_AGENT" \
              -H "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8" \
              -H "Referer: $URL" \
              "$URL" 2>/dev/null || echo "HTTPSTATUS:000;TIME:0")

            http_code2=$(echo "$response2" | sed -n 's/.*HTTPSTATUS:\([0-9]*\).*/\1/p')
            time2=$(echo "$response2" | sed -n 's/.*TIME:\([0-9.]*\).*/\1/p')
            
            echo "   ğŸ”„ Interaction response: HTTP $http_code2, Time: ${time2}s"

            # Phase 4: ê°„ë‹¨í•œ ì„¸ì…˜ ìœ ì§€ (1íšŒë§Œ)
            echo "ğŸ’“ Phase 4: Simple keep-alive"
            sleep 5
            curl -s --max-time 10 \
              -H "User-Agent: $USER_AGENT" \
              -H "Accept: */*" \
              -H "Referer: $URL" \
              "$URL" > /dev/null 2>&1 || true
            echo "   ğŸ’— Keep-alive signal sent"

            # ê²°ê³¼ í‰ê°€
            if [[ "$http_code1" =~ ^[23] ]] || [[ "$http_code2" =~ ^[23] ]] || [[ "$http_code1" == "303" ]]; then
              echo "âœ… Simple user simulation completed successfully!"
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
            else
              echo "âš ï¸ App might be having issues"
              echo "   ğŸ”§ HTTP codes: $http_code1, $http_code2"
              # ì‘ë‹µì´ ìˆìœ¼ë©´ ì„±ê³µìœ¼ë¡œ ì¹´ìš´íŠ¸
              if [[ "$http_code1" != "000" ]] || [[ "$http_code2" != "000" ]]; then
                SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
              fi
            fi

            # ë‹¤ìŒ URL ì²˜ë¦¬ ì „ íœ´ì‹ (2-5ì´ˆ)
            tab_switch_delay=$((2 + RANDOM % 4))
            echo "   ğŸ”„ Next app in ${tab_switch_delay}s..."
            sleep $tab_switch_delay
          }

          # ëª¨ë“  URLì— ëŒ€í•´ ì‹¤í–‰
          echo "ğŸš€ Starting simplified user activity simulation"
          echo "â° Current time: $(date)"
          
          for raw in "${ADDR[@]}"; do
            simulate_simple_user "$raw"
          done

          # ìµœì¢… ë¦¬í¬íŠ¸
          echo "\nğŸ“Š === SIMULATION COMPLETE ==="
          echo "âœ… Successfully simulated: $SUCCESS_COUNT / $TOTAL_COUNT apps"
          echo "ğŸ“ˆ Success Rate: $(( SUCCESS_COUNT * 100 / TOTAL_COUNT ))%"
          echo "â° Total simulation time: ~$(( TOTAL_COUNT * 20 )) seconds"

          if [ $SUCCESS_COUNT -eq $TOTAL_COUNT ]; then
            echo "ğŸ‰ All apps received simple user activity!"
            echo "   ğŸ›¡ï¸ Apps should stay awake with minimal resource usage"
          elif [ $SUCCESS_COUNT -gt 0 ]; then
            echo "âš ï¸ Partial success - some apps may need attention"
          else
            echo "âŒ Simulation failed for all apps"
            exit 1
          fi

          echo "\nğŸ¯ Next simple simulation in 6 hours"
          echo "ğŸ’¡ Lightweight approach should reduce mobile access delays"