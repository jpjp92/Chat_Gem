name: Simplified User Activity Simulator

on:
  schedule:
    # 다양한 시간대에 실행 (실제 사용자 패턴 모방)
    - cron: "15 */6 * * *"   # 매 6시간마다 15분에
  workflow_dispatch:

env:
  STREAMLIT_URL: ${{ secrets.STREAMLIT_URL }}
  STREAMLIT_URLS: ${{ secrets.STREAMLIT_URLS }}

jobs:
  simplified-simulation:
    runs-on: ubuntu-latest
    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Simplified User Activity Simulation
        run: |
          # URL 설정
          URLS="$STREAMLIT_URLS"
          if [ -z "$URLS" ]; then
            URLS="$STREAMLIT_URL"
          fi
          if [ -z "$URLS" ]; then
            URLS="https://assistant-gemini25.streamlit.app,https://mbti-multi.streamlit.app,https://ko-chat-bot25.streamlit.app"
            echo "🔗 Using default URL list"
          fi

          if [ -z "$URLS" ]; then
            echo "❌ No URLs configured"
            exit 1
          fi

          IFS=',' read -ra ADDR <<< "$URLS"
          SUCCESS_COUNT=0
          TOTAL_COUNT=0

          # 랜덤 User-Agent 배열
          USER_AGENTS=(
            "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
            "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
            "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/121.0"
            "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
          )

          simulate_simple_user() {
            raw="$1"
            URL=$(echo "$raw" | sed -e 's/^\s*//' -e 's/\s*$//')
            URL="${URL%/}"
            TOTAL_COUNT=$((TOTAL_COUNT + 1))
            
            # 랜덤 User-Agent 선택
            UA_INDEX=$((RANDOM % ${#USER_AGENTS[@]}))
            USER_AGENT="${USER_AGENTS[$UA_INDEX]}"
            
            echo "\n🎭 === Simple user simulation for: $URL ==="
            echo "👤 User-Agent: $(echo "$USER_AGENT" | cut -d' ' -f1-3)..."

            # Phase 1: 메인 페이지 방문
            echo "📱 Phase 1: Main page visit"
            response1=$(curl -s -L --max-time 30 \
              -w "HTTPSTATUS:%{http_code};TIME:%{time_total};SIZE:%{size_download}" \
              -H "User-Agent: $USER_AGENT" \
              -H "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8" \
              -H "Accept-Language: en-US,en;q=0.9,ko;q=0.8" \
              -H "Connection: keep-alive" \
              -H "Cache-Control: max-age=0" \
              "$URL" 2>/dev/null || echo "HTTPSTATUS:000;TIME:0;SIZE:0")

            http_code1=$(echo "$response1" | sed -n 's/.*HTTPSTATUS:\([0-9]*\).*/\1/p')
            time1=$(echo "$response1" | sed -n 's/.*TIME:\([0-9.]*\).*/\1/p')
            size1=$(echo "$response1" | sed -n 's/.*SIZE:\([0-9]*\).*/\1/p')
            
            echo "   📊 HTTP: $http_code1, Time: ${time1}s, Size: ${size1} bytes"

            # 사용자 페이지 읽기 시뮬레이션 (3-8초)
            read_time=$((3 + RANDOM % 6))
            echo "   👀 User reading... (${read_time}s)"
            sleep $read_time

            # Phase 2: 간단한 리소스 요청
            echo "📦 Phase 2: Basic resource loading"
            
            # Favicon 요청만 (가장 일반적)
            curl -s --max-time 10 \
              -H "User-Agent: $USER_AGENT" \
              -H "Accept: image/*,*/*;q=0.8" \
              -H "Referer: $URL" \
              "$URL/favicon.ico" > /dev/null 2>&1 || true

            sleep 2

            # Phase 3: 한 번의 추가 상호작용
            echo "🖱️ Phase 3: User interaction"
            response2=$(curl -s -L --max-time 20 \
              -w "HTTPSTATUS:%{http_code};TIME:%{time_total}" \
              -H "User-Agent: $USER_AGENT" \
              -H "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8" \
              -H "Referer: $URL" \
              "$URL" 2>/dev/null || echo "HTTPSTATUS:000;TIME:0")

            http_code2=$(echo "$response2" | sed -n 's/.*HTTPSTATUS:\([0-9]*\).*/\1/p')
            time2=$(echo "$response2" | sed -n 's/.*TIME:\([0-9.]*\).*/\1/p')
            
            echo "   🔄 Interaction response: HTTP $http_code2, Time: ${time2}s"

            # Phase 4: 간단한 세션 유지 (1회만)
            echo "💓 Phase 4: Simple keep-alive"
            sleep 5
            curl -s --max-time 10 \
              -H "User-Agent: $USER_AGENT" \
              -H "Accept: */*" \
              -H "Referer: $URL" \
              "$URL" > /dev/null 2>&1 || true
            echo "   💗 Keep-alive signal sent"

            # 결과 평가
            if [[ "$http_code1" =~ ^[23] ]] || [[ "$http_code2" =~ ^[23] ]] || [[ "$http_code1" == "303" ]]; then
              echo "✅ Simple user simulation completed successfully!"
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
            else
              echo "⚠️ App might be having issues"
              echo "   🔧 HTTP codes: $http_code1, $http_code2"
              # 응답이 있으면 성공으로 카운트
              if [[ "$http_code1" != "000" ]] || [[ "$http_code2" != "000" ]]; then
                SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
              fi
            fi

            # 다음 URL 처리 전 휴식 (2-5초)
            tab_switch_delay=$((2 + RANDOM % 4))
            echo "   🔄 Next app in ${tab_switch_delay}s..."
            sleep $tab_switch_delay
          }

          # 모든 URL에 대해 실행
          echo "🚀 Starting simplified user activity simulation"
          echo "⏰ Current time: $(date)"
          
          for raw in "${ADDR[@]}"; do
            simulate_simple_user "$raw"
          done

          # 최종 리포트
          echo "\n📊 === SIMULATION COMPLETE ==="
          echo "✅ Successfully simulated: $SUCCESS_COUNT / $TOTAL_COUNT apps"
          echo "📈 Success Rate: $(( SUCCESS_COUNT * 100 / TOTAL_COUNT ))%"
          echo "⏰ Total simulation time: ~$(( TOTAL_COUNT * 20 )) seconds"

          if [ $SUCCESS_COUNT -eq $TOTAL_COUNT ]; then
            echo "🎉 All apps received simple user activity!"
            echo "   🛡️ Apps should stay awake with minimal resource usage"
          elif [ $SUCCESS_COUNT -gt 0 ]; then
            echo "⚠️ Partial success - some apps may need attention"
          else
            echo "❌ Simulation failed for all apps"
            exit 1
          fi

          echo "\n🎯 Next simple simulation in 6 hours"
          echo "💡 Lightweight approach should reduce mobile access delays"